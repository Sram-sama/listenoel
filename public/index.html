<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ðŸŽ„ Listes de NoÃ«l ðŸŽ„</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f9f9f9;
    margin: 0;
    padding: 20px;
  }

  h1 { text-align: center; color: #c0392b; }
  h2 { color: #2980b9; }
  h3 { margin-bottom: 5px; }

  #login, #main {
    max-width: 500px;
    margin: auto;
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }

  select,
  input:not([type="checkbox"]):not([type="button"]):not([type="submit"]),
  textarea,
  button {
    padding: 8px;
    margin: 5px 0;
    width: 100%;
    box-sizing: border-box;
    border-radius: 5px;
    border: 1px solid #ccc;
  }

  textarea { resize: vertical; }

  button {
    background: #2980b9;
    color: white;
    border: none;
    cursor: pointer;
  }
  button:hover { background: #3498db; }

  ul { list-style: none; padding-left: 0; margin: 0; }
  li { padding: 5px 0; }

  label {
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  #others div {
    margin-bottom: 15px;
    background: #f1f1f1;
    padding: 10px;
    border-radius: 5px;
  }

  /* Styles popup */
  #confirmPopup, #pinPopup {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }

  #confirmPopup div, #pinPopup div {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    max-width: 400px;
    width: 90%;
    text-align: center;
  }

  #confirmPopup button, #pinPopup button {
    margin: 5px;
    width: 80px;
  }

  /* Clavier PIN */
  #keypad {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-top: 10px;
  }

  #keypad button {
    padding: 15px;
    font-size: 18px;
    border-radius: 5px;
  }

  #pinInput {
    text-align: center;
    font-size: 18px;
    letter-spacing: 5px;
    width: 100%;
    margin-bottom: 10px;
  }

  input[type="checkbox"] {
    width: auto;
    height: auto;
    margin: 0;
  }

  #changePinBtn {
    margin-top: 20px;
    background: #27ae60;
  }
</style>
</head>
<body>

<h1>ðŸŽ„ Listes de NoÃ«l ðŸŽ„</h1>

<div id="login">
  <h3>Choisir votre nom :</h3>
  <select id="userSelect">
    <option value="">-- SÃ©lectionner --</option>
  </select>

  <h3>Entrez votre PIN :</h3>
  <input type="password" id="pinInput" placeholder="****" readonly/>

  <div id="keypad">
    <button class="num">1</button>
    <button class="num">2</button>
    <button class="num">3</button>
    <button class="num">4</button>
    <button class="num">5</button>
    <button class="num">6</button>
    <button class="num">7</button>
    <button class="num">8</button>
    <button class="num">9</button>
    <button id="clear">Effacer</button>
    <button class="num">0</button>
    <button id="enter">âœ”</button>
  </div>
</div>

<div id="main" style="display:none;">
  <h2>Mes cadeaux</h2>
  <ul id="myList"></ul>

  <h3>Ajouter un cadeau Ã  ma liste :</h3>
  <input id="newItem" placeholder="Nom du cadeau">
  <textarea id="newComment" placeholder="Commentaire / lien (optionnel)"></textarea>
  <button id="addBtn">Ajouter</button>

  <h2>Autres listes</h2>
  <div id="others"></div>

  <button id="changePinBtn">Changer mon code PIN</button>
</div>

<!-- Popup confirmation -->
<div id="confirmPopup">
  <div>
    <p id="confirmMessage"></p>
    <button id="confirmYes">Oui</button>
    <button id="confirmNo">Non</button>
  </div>
</div>

<!-- Popup changement de PIN -->
<div id="pinPopup">
  <div>
    <h3>Changer votre code PIN</h3>
    <input type="password" id="newPin" placeholder="Nouveau code PIN (4 chiffres)" maxlength="4">
    <input type="password" id="confirmPin" placeholder="Confirmez le code PIN" maxlength="4">
    <button id="savePin">Valider</button>
    <button id="cancelPin">Annuler</button>
  </div>
</div>

<script>
let currentUser;
let data;

async function loadData() {
  const res = await fetch("/data");
  data = await res.json();
  const select = document.getElementById("userSelect");
  select.innerHTML = "<option value=''>-- SÃ©lectionner --</option>";
  data.users.forEach(u => {
    select.innerHTML += `<option value="${u.name}">${u.name}</option>`;
  });
}

// Gestion clavier PIN
document.querySelectorAll(".num").forEach(btn => {
  btn.onclick = () => {
    const input = document.getElementById("pinInput");
    if (input.value.length < 4) input.value += btn.textContent;
  };
});

document.getElementById("clear").onclick = () => {
  document.getElementById("pinInput").value = "";
};

document.getElementById("enter").onclick = () => {
  const pin = document.getElementById("pinInput").value;
  const sel = document.getElementById("userSelect").value;
  if (!sel) {
    alert("SÃ©lectionnez un utilisateur");
    return;
  }

  const user = data.users.find(u => u.name === sel);
  if (!user) {
    alert("Utilisateur introuvable");
    return;
  }
  if (pin !== user.pin) {
    alert("PIN incorrect");
    document.getElementById("pinInput").value = "";
    return;
  }

  currentUser = sel;
  document.getElementById("login").style.display = "none";
  document.getElementById("main").style.display = "block";
  renderLists();
};

function renderLists() {
  const myList = document.getElementById("myList");
  myList.innerHTML = "";
  const me = data.users.find(u => u.name === currentUser) || { list: [] };
  me.list.forEach(itemObj => {
    const li = document.createElement("li");
    li.textContent = `- ${itemObj.name}${itemObj.comment ? ` (${itemObj.comment})` : ""}`;
    myList.appendChild(li);
  });

  const others = document.getElementById("others");
  others.innerHTML = "";
  data.users
    .filter(u => u.name !== currentUser)
    .forEach(u => {
      const div = document.createElement("div");
      div.innerHTML = `<h3>${u.name}</h3>`;
      const ul = document.createElement("ul");
      u.list.forEach(itemObj => {
        const li = document.createElement("li");
        const checkedDisabled = data.purchases && data.purchases[u.name] && data.purchases[u.name][itemObj.name] ? 'checked disabled' : '';
        li.innerHTML = `
          <label>
            <input type="checkbox" ${checkedDisabled} onclick="markPurchase('${u.name}','${itemObj.name}', this)">
            ${itemObj.name}${itemObj.comment ? ` (${itemObj.comment})` : ""}
          </label>`;
        ul.appendChild(li);
      });
      div.appendChild(ul);
      others.appendChild(div);
    });
}

// Popup intÃ©grÃ©e
function markPurchase(user, item, checkbox) {
  const popup = document.getElementById("confirmPopup");
  const message = document.getElementById("confirmMessage");
  message.textContent = `Attention, Ãªtes-vous sÃ»r de rÃ©server le cadeau "${item}" pour ${user} ?`;
  popup.style.display = "flex";

  const yesBtn = document.getElementById("confirmYes");
  const noBtn = document.getElementById("confirmNo");

  const clean = () => {
    popup.style.display = "none";
    yesBtn.onclick = null;
    noBtn.onclick = null;
  };

  yesBtn.onclick = async () => {
    await fetch("/purchase", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user, item })
    });
    checkbox.checked = true;
    checkbox.disabled = true;
    clean();
  };

  noBtn.onclick = () => {
    checkbox.checked = false;
    clean();
  };
}

document.getElementById("addBtn").onclick = async () => {
  const val = document.getElementById("newItem").value.trim();
  const comment = document.getElementById("newComment").value.trim();
  if (!val) return;
  await fetch("/addItem", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user: currentUser, item: val, comment })
  });
  document.getElementById("newItem").value = "";
  document.getElementById("newComment").value = "";
  await loadData();
  renderLists();
};

// Changement de PIN
document.getElementById("changePinBtn").onclick = () => {
  document.getElementById("pinPopup").style.display = "flex";
};

document.getElementById("cancelPin").onclick = () => {
  document.getElementById("pinPopup").style.display = "none";
};

document.getElementById("savePin").onclick = async () => {
  const newPin = document.getElementById("newPin").value.trim();
  const confirmPin = document.getElementById("confirmPin").value.trim();
  if (newPin.length !== 4 || isNaN(newPin)) {
    alert("Le code PIN doit contenir exactement 4 chiffres.");
    return;
  }
  if (newPin !== confirmPin) {
    alert("Les codes PIN ne correspondent pas.");
    return;
  }

  await fetch("/updatePin", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user: currentUser, newPin })
  });

  alert("Votre code PIN a Ã©tÃ© mis Ã  jour !");
  document.getElementById("pinPopup").style.display = "none";
  await loadData();
};

loadData();
</script>

</body>
</html>
